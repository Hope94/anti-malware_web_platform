import os
from django.db import transaction
from typing import Union

os.environ.setdefault ('DJANGO_SETTINGS_MODULE', 'pfe_plateforme_web.settings')

import django

django.setup ()


from collections import defaultdict
from django.forms.models import model_to_dict
from main.models import Apk, Feature, Extract, Dataset, Model,VectorSpace,DetectionResult
from pfe_plateforme_web.settings import APK_DIR



def settingSqlite():
    from django.db import connection
    cursor = connection.cursor ()
    cursor.execute ('PRAGMA temp_store = MEMORY;')
    cursor.execute ('PRAGMA synchronous=OFF')
    cursor.execute ("PRAGMA default_cache_size = 10000")





def insert_apk(info:dict,malignity=-1) -> Apk:
    apk = Apk.objects.get_or_create (name=info['name']
                                     , malignity=malignity
                                     , package=info['package']
                                     , developer=info['developer']
                                     , displayed_version=info['displayed_version']
                                     , size=info['size'], md5=info['md5'], sha1=info['sha1'], sha256=info['sha256'])[0]
    apk.save ()
    return apk


def insert_feature(name, type) -> Feature:
    feature = Feature.objects.get_or_create (name=name, type=type)[0]
    feature.save ()
    return feature


def is_extract_in_db(apk, feature):
    num_results = Extract.objects.filter (apk=apk, feature=feature).count ()
    return num_results != 0


def insert_extract(apk, feature, nb_feature) -> Extract:
    if (is_extract_in_db (apk=apk, feature=feature)):
        extract = Extract.objects.get (apk=apk, feature=feature)
    else:
        extract = Extract.objects.get_or_create (apk=apk, feature=feature, nb_feature=nb_feature)[0]
        extract.save ()
    return extract


def insert_apk_features(apk, list_features: list) -> Extract:
    list_extract = [
        Extract (apk=apk,
                 feature=item[0],
                 nb_feature=item[1]
                 )
        for item in list_features if not is_extract_in_db (apk=apk, feature=item[0])
    ]
    extract = Extract.objects.bulk_create (list_extract)
    return extract




def get_apk_record(apk_id: int) -> Apk:
    apk = Apk.objects.get (pk=apk_id)
    return apk


def get_apks() -> list:
    return [apk for apk in Apk.objects.all ()]

def get_dataset(name: str) -> Dataset:
    return Dataset.objects.get (name=name)

def get_datasets(datasets: list) -> list:
    _datasets=[]
    for dataset in datasets:
        _datasets.append(Dataset.objects.get (name=dataset))
    return _datasets

def get_apk_features(apk_id: int) -> list:
    apk = Apk.objects.get (pk=apk_id)
    list_extract=apk.extractions.all()
    #list_extract = Extract.objects.filter (apk=apk).all ()
    return [(e.feature, e.nb_feature) for e in list_extract]

def get_apk_features_ids(apk_id: int) -> dict:
    apk = Apk.objects.get (pk=apk_id)
    list_extract=apk.extractions.all()
    return {e.feature.pk : e.nb_feature for e in list_extract}

def get_feature(type: str, name: str) -> Feature:
    return Feature.objects.get (name=name, type=type)


def get_apk_malignity(apk_name: str) -> int:
    apk = Apk.objects.get (name=apk_name)
    return apk.malignity


def get_datasets_apks(datasets: list) -> set:
    apks = set ()
    for dataset in datasets:
        apks.update (dataset.apk_set.all ())
    return apks


def get_apks_in_datasets(datasets: list) -> list:
    apks=Apk.objects.filter(datasets__name__in=datasets).distinct()
    return [(apk.pk,apk.malignity) for apk in apks]


def is_apk_in_db(sha256) -> bool:
    num_results = Apk.objects.filter (sha256=sha256).count ()
    return num_results != 0

def add_apk_to_dataset(apk: Apk, dataset_name: str):
    dataset = Dataset.objects.get_or_create (name=dataset_name)[0]
    dataset.save ()
    apk.datasets.add (dataset)
    apk.save ()

def insert_model(name,path,type_cls,auc,tp,tn,fp,fn,vs):
    model=Model.objects.get_or_create(name=name,path=path,type_cls=type_cls,
                                      auc=auc,tp=tp,fp=fp,tn=tn,fn=fn,vs=vs)[0]
    model.save()
    return model

def insert_vector_space(rep_type:str,scal:str):
    vs=VectorSpace.objects.get_or_create(representation_type=rep_type,scal=scal)[0]
    vs.save()
    return vs

@transaction.atomic
def add_features_to_vs(vs:VectorSpace,features:list):
    for f in features:
        vs.features.add(f)
    vs.save()

def is_detection_result_in_db(apk:Apk, model:Model):
        num_results = DetectionResult.objects.filter (apk=apk, model=model).count ()
        return num_results != 0



def insert_detection_result(prediction:bool,score:float,apk:Apk, model):
    if is_detection_result_in_db(apk=apk,model=model):
        res_detect=DetectionResult.objects.get(apk=apk,model=model)
    else:
        res_detect=DetectionResult.objects.get_or_create(prediction=prediction,score=score
                                                         ,apk=apk,model=model)[0]
        res_detect.save()
    return res_detect

def get_apk_detection_results(apk:Apk):
    return apk.detection_results

def get_models():
    return Model.objects.all()

def get_vector_space_features(vs_id:int):
    vs=VectorSpace.objects.get(pk=vs_id)
    return vs.features.all()



def get_datasets_features(datasets_name:list, type_features:list):
    datasets=[dataset for dataset in Dataset.objects.filter(name__in=datasets_name)]
    features= Feature.objects.filter (type__in=type_features, extractions__apk__in=Apk.objects.filter(datasets__in=datasets)).distinct()
    return features


def get_datasets_features(datasets_name:list, type_features:list):
    datasets=[dataset for dataset in Dataset.objects.filter(name__in=datasets_name)]
    features= Feature.objects.filter (type__in=type_features, extractions__apk__in=Apk.objects.filter(datasets__in=datasets)).distinct()
    return features
if __name__ == '__main__':
    dex_features=['r_api_ps','used_permission_ps','r_api_ax','used_permission_ax','r_api_ps_ax','url','used_api']

    features=Feature.objects.all()
    print('count features',features.count())

    dex_features=Feature.objects.filter(type__in=dex_features)
    print('count dex features',dex_features.count())


    extracts=Extract.objects.all()
    print('count extract',extracts.count())

    dex_extracts = Extract.objects.filter(feature__type__in=dex_features)
    print ('count dex extract', dex_extracts.count ())




